<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Daniel Standage</title>
	<meta name="description" content="">
	<meta name="author" content="Daniel S. Standage">

	<!-- HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="https://standage.github.io/theme/html5.js"></script>
	<![endif]-->

	<!-- Styles -->
	<link href="https://standage.github.io/theme/bootstrap.min.css" rel="stylesheet">
	<link href="https://standage.github.io/theme/local.css" rel="stylesheet">
	<link href="https://standage.github.io/theme/pygments.css" rel="stylesheet">

	<!-- Feeds -->
	<link href="https://standage.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Daniel Standage Atom Feed" />


	<link href="https://standage.github.io/feed.xml" type="application/rss+xml" rel="alternate" title="Daniel Standage RSS Feed" />


<script type="text/javascript">
	var disqus_identifier = "shell-pipelines-in-python.html";
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = 'https://standage-github-io.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
</head>
<body>
	<div class="topbar">
	  <div class="topbar-inner">
		<div class="container-fluid">
		  <a class="brand" href="https://standage.github.io/">Daniel Standage</a>
			<ul class="nav">
						<li><a href="https://standage.github.io/pages/vitae.html">Vitae</a></li>
						<li><a href="https://standage.github.io/pages/teaching.html">Teaching</a></li>
						<li><a href="https://standage.github.io/pages/software-databases.html">Software & Databases</a></li>
				<li><a href="https://standage.github.io/notebook.html">Notebook</a></li>
			</ul>
			<p class="pull-right"><a href="https://standage.github.io/archives.html">[archives]</a> <a href="https://standage.github.io/categories.html">[categories]</a> <a href="https://standage.github.io/tags.html">[tags]</a></p>
		</div>
	  </div>
	</div>

	<div class="container-fluid">
	  <div class="sidebar">
		<div class="well">
			<img src="http://1.gravatar.com/avatar/fe326141c425326acf247aef9c475c03?size=180" alt="Daniel Standage" />
			<h3>Daniel S. Standage</h3>
			<p>
				205A Simon Hall<br />
				Indiana University<br />
				212 South Hawthorne Drive<br />
				Bloomington, IN 47405<br />
			</p>
			<h3>Affiliations</h3>
			<ul>
				<li><a href="http://brendelgroup.org/">Brendel Group</a></li>
				<li><a href="http://www.public.iastate.edu/~amytoth/Toth_lab/Home.html">Toth Lab</a></li>
				<li><a href="http://www.bio.indiana.edu/">Indiana Biology Department</a></li>
				<li><a href="http://www.bcb.iastate.edu/">Iowa State BCB Program</a></li>
			</ul>
			<div class="social">
			<h3>Social</h3>
			<ul>
				<li><a href="http://github.com/standage">GitHub</a></li>
				<li><a href="https://twitter.com/byuhobbes">Twitter</a></li>
				<li><a href="http://stackexchange.com/users/208980/daniel-standage?tab=accounts">StackExchange</a></li>
			</ul>
			</div>
		</div>
	  </div>
	  <div class="content">
	<div class='article'>
		<div class="page-header"><h1>Shell pipelines in Python</h1></div>
		<div class="well small">Permalink: <a class="more" href="https://standage.github.io/shell-pipelines-in-python.html">2015-12-15</a>
by <a class="url fn" href="https://standage.github.io/author/daniel-s-standage.html">Daniel S. Standage </a>
 in <a href="https://standage.github.io/category/blog.html">blog</a>
tags: <a href="https://standage.github.io/tag/shell.html">shell</a> <a href="https://standage.github.io/tag/python.html">python</a> </div>
		<div><p>The UNIX shell is an indispensible tool for project organization and data management in bioinformatics.
I spend <em>a lot</em> of time in the shell, and having picked up on a lot of time-saving techniques over the years it might just be my favorite computing environment.</p>
<p>The shell has its limitations, however.
Piping, the very feature that gives the shell its amazing power and flexibility, can also lead to some pretty gruesome syntax.
Debugging shell code is tough, the error handling is rudimentary, and good luck finding a good framework for automated tests.
In short, the shell is great for interactive computing and automating simple tasks, but when it comes to workflows requiring more fine-grained control, a language like Python is often a better choice.</p>
<p>Here I provide a Python translation of several shell commands.</p>
<h2>Simplest case</h2>
<p>You don't typically get much bioinformatics work done with a single command without arguments.
Anything substantial will involve data files, parameters, and so on, that are typically specified using arguments on the command line (you don't have these hard coded in a script, do you?!?!).
But just for sake of completeness, it's very straightforward to execute shell commands this way in Python.</p>
<div class="highlight"><pre>ls
</pre></div>


<p>The Python equivalent is as follows.</p>
<div class="highlight"><pre><span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="s1">&#39;ls&#39;</span><span class="p">)</span>
</pre></div>


<p>There is even the simpler <code>call</code> function...</p>
<div class="highlight"><pre><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;ls&#39;</span><span class="p">)</span>
</pre></div>


<p>...but for most situations I find the <code>check_call</code> more useful, since it will halt the Python code immediately if the subprocess returns a non-zero status.</p>
<h2>Command with arguments</h2>
<div class="highlight"><pre>ls -lhp
</pre></div>


<p>Commands with arguments cannot simply be dropped in to the <code>check_call</code> command as-is.
The following code will fail.</p>
<div class="highlight"><pre><span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="s1">&#39;ls -lhp&#39;</span><span class="p">)</span>
</pre></div>


<p>There are two ways you can fix this: the convenient (and wrong and insecure) way...</p>
<div class="highlight"><pre><span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="s1">&#39;ls -lhp&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>


<p>...and The Right Way.</p>
<div class="highlight"><pre><span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s1">&#39;ls&#39;</span><span class="p">,</span> <span class="s1">&#39;-lhp&#39;</span><span class="p">])</span>
</pre></div>


<p>The convenience of the first method comes at the cost of security: the <code>shell=True</code> setting introduces vulnerability to <a href="https://security.openstack.org/guidelines/dg_use-subprocess-securely.html">shell injections</a>.
This isn't the type of thing you expect to encounter much in the research setting, but it's an important consideration nonetheless, and exceptions should be made with caution.</p>
<p>This example is pretty silly, since you'll probably never need to call the <code>ls</code> command from Python.
Let's do a different example you're much more likely to encounter in bioinformatics.</p>
<div class="highlight"><pre>blastx -db /opt/ncbi/nr -query tsa.fasta <span class="se">\</span>
       -evalue 1e-4 -num_threads $numthreads <span class="se">\</span>
       -out tsa-vs-nr.blastx
</pre></div>


<p>The Python equivalent is as follows.</p>
<div class="highlight"><pre><span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blastx&#39;</span><span class="p">,</span> <span class="s1">&#39;-db&#39;</span><span class="p">,</span> <span class="s1">&#39;/opt/ncbi/nr&#39;</span><span class="p">,</span> <span class="s1">&#39;-query&#39;</span><span class="p">,</span> <span class="s1">&#39;tsa.fasta&#39;</span><span class="p">,</span>
           <span class="s1">&#39;-evalue&#39;</span><span class="p">,</span> <span class="s1">&#39;1e-4&#39;</span><span class="p">,</span> <span class="s1">&#39;-num_threads&#39;</span><span class="p">,</span> <span class="n">numthreads</span><span class="p">,</span>
           <span class="s1">&#39;-out&#39;</span><span class="p">,</span> <span class="s1">&#39;tsa-vs-nr.blastx&#39;</span><span class="p">]</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</pre></div>


<h2>Redirect stdin and stdout</h2>
<p>Many programs and commands allow you to specify input and output files as arguments, as in the <code>blastx</code> command above.
However, sometimes your only options are <code>stdin</code> and/or <code>stdout</code>.</p>
<div class="highlight"><pre>sed s/^scaffold_/PcanScaf/ &lt; pcan-in.gff3 &gt; pcan-out.gff3
</pre></div>


<p>Here is the Python equivalent.</p>
<div class="highlight"><pre><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;pcan-in.gff3&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">instream</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;pcan-out.gff3&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outstream</span><span class="p">:</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s1">&#39;sed&#39;</span><span class="p">,</span> <span class="s1">&#39;s/^scaffold_/PcanScaf/&#39;</span><span class="p">],</span> <span class="n">stdin</span><span class="o">=</span><span class="n">instream</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">outstream</span><span class="p">)</span>
</pre></div>


<h2>The main event: pipelines</h2>
<p>Handling input and output for single commands is great and all, but the real power of the shell is piping commands together like so.</p>
<div class="highlight"><pre>grep -v <span class="s1">$&#39;\tintron\t&#39;</span> loci.gff3 <span class="se">\</span>
    <span class="p">|</span> pmrna --locus --accession --map<span class="o">=</span>map.txt <span class="se">\</span>
    <span class="p">|</span> canon-gff3 --outfile<span class="o">=</span>locus.mrnas.gff3 
</pre></div>


<p>Unless we want to introduce security vulnerabilities, we cannot simply run these commands with a single call to the <code>check_call</code> function.
For this use case, we want to use the <code>Popen</code> constructor and the <code>communicate</code> method.</p>
<div class="highlight"><pre><span class="n">grepproc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;grep&#39;</span><span class="p">,</span> <span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">intron</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;loci.gff3&#39;</span><span class="p">],</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
<span class="n">pmrnaproc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;pmrna&#39;</span><span class="p">,</span> <span class="s1">&#39;--locus&#39;</span><span class="p">,</span> <span class="s1">&#39;--accession&#39;</span><span class="p">,</span> <span class="s1">&#39;--map=map.txt&#39;</span><span class="p">],</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">grepproc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
<span class="n">canonproc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;canon-gff3&#39;</span><span class="p">,</span> <span class="s1">&#39;--outfile=locus.mrnas.gff3&#39;</span><span class="p">],</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">pmrnaproc</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
<span class="n">canonproc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
</pre></div>


<p>If needed, it is trivial to capture the terminal output like so.</p>
<div class="highlight"><pre><span class="n">grepproc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;grep&#39;</span><span class="p">,</span> <span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">intron</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;loci.gff3&#39;</span><span class="p">],</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
<span class="n">pmrnaproc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;pmrna&#39;</span><span class="p">,</span> <span class="s1">&#39;--locus&#39;</span><span class="p">,</span> <span class="s1">&#39;--accession&#39;</span><span class="p">,</span> <span class="s1">&#39;--map=map.txt&#39;</span><span class="p">],</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">grepproc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
<span class="n">canonproc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;canon-gff3&#39;</span><span class="p">,</span> <span class="s1">&#39;--outfile=locus.mrnas.gff3&#39;</span><span class="p">],</span>
                             <span class="n">stdin</span><span class="o">=</span><span class="n">pmrnaproc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                             <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
<span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">canonproc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stderr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="c1"># process the terminal warnings</span>
</pre></div>


<h2>Coda</h2>
<p>That's it!</p>
<p>Python's <code>subprocess</code> module is pretty powerful, and allows even slicker interactions with the shell, such as printing text to a pipeline of shell commands.
However, writing to and reading from a pipeline simultaneously can get tricky and is prone to deadlocks.
I will not cover this here, but the Internet is full of blog posts and StackOverflow threads discussing the intricacies of the <code>subprocess</code> for these more complicated use cases.</p></div>
		<div>
			<h2>Comments</h2>
<div id="disqus_thread"></div>		<div>
	</div>
		<footer>
		  <p>
			<a href="http://creativecommons.org/licenses/by/4.0/"><img src="https://standage.github.io/images/cc-by-88x31.png" alt="CC BY 4.0" /></a><br />
		    &copy; 2015-2016 Daniel S. Standage.<br />
			Unless otherwise noted, all content on this site is posted under a <a href="http://creativecommons.org/licenses/by/4.0/">CC BY license</a>.</p>
		  <p></p>
		  <p>This site is powered by <a href="http://getpelican.com/">Pelican</a>, its theme based on <a href="http://twitter.github.com/bootstrap/">Twitter Bootstrap</a>.</p>
		</footer>
	  </div>

	</div>
</body>
</html>